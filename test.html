<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>押し引き判定（副露 vs リーチ）</title>
    <!-- Bootstrap CSSを読み込む -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <style>
        .bg-pressed {
            background-color: #d4edda;
        }

        .bg-not-pressed {
            background-color: #f8d7da;
        }

    </style>
</head>

<body>
    <div class="container">
        <h2 class="text-center mt-5 mb-4">押し引き判定（副露 vs リーチ）</h2>
        <form id="form" class="bg-light rounded-3 p-4">
            <div class="mb-3">
                <label class="form-label">ルール</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="rule" id="tenho" value="tenho" checked>
                    <label class="form-check-label" for="tenho">天鳳ルール（段位戦 七段）</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="rule" id="mleague" value="mleague">
                    <label class="form-check-label" for="mleague">Mリーグルール（25,000点持ち 30,000点返し ウマ1-3）</label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">場</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="round" id="east1" value="east1" checked>
                    <label class="form-check-label" for="east1">東1局</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="round" id="east2" value="east2">
                    <label class="form-check-label" for="east2">東2局</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="round" id="east3" value="east3">
                    <label class="form-check-label" for="east3">東3局</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="round" id="east4" value="east4">
                    <label class="form-check-label" for="east4">東4局</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="round" id="south1" value="south1">
                    <label class="form-check-label" for="south1">南1局</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="round" id="south2" value="south2">
                    <label class="form-check-label" for="south2">南2局</label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">持ち点</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="point" id="point-1" value="15000" checked>
                    <label class="form-check-label" for="point-1">14,000点 ~ 16,000点</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="point" id="point-2" value="25000">
                    <label class="form-check-label" for="point-2">24,000点 ~ 26,000点</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="point" id="point-3" value="35000">
                    <label class="form-check-label" for="point-3">34,000点 ~ 36,000点</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="point" id="point-4" value="45000">
                    <label class="form-check-label" for="point-4">44,000点 ~ 46,000点</label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">打点</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="score" id="score-1" value="1000" checked>
                    <label class="form-check-label" for="score-1">子 1000点 親 1500点</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="score" id="score-2" value="2000">
                    <label class="form-check-label" for="score-2">子 2000点 親 2900点</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="score" id="score-3" value="3900">
                    <label class="form-check-label" for="score-3">子 3900点 親 5800点</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="score" id="score-4" value="7700">
                    <label class="form-check-label" for="score-4">子 7700点 親 11600点</label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">供託</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="deposit" id="deposit-1" value="1000" checked>
                    <label class="form-check-label" for="deposit-1">1000点</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="deposit" id="deposit-2" value="2000">
                    <label class="class=" form-check-label" for="deposit-2">2000点</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="deposit" id="deposit-3" value="3000">
                    <label class="form-check-label" for="deposit-3">3000点</label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">待ち</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="isRyokei" id="isRyokei-1" value="1" checked>
                    <label class="form-check-label" for="isRyokei-1">良形</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="isRyokei" id="isRyokei-2" value="0">
                    <label class="form-check-label" for="isRyokei-2">愚形</label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">放銃率</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="hojuRate" id="hojuRate-1" value="5" checked>
                    <label class="form-check-label" for="hojuRate-1">5%（スジ9本 外側28）</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="hojuRate" id="hojuRate-2" value="10">
                    <label class="form-check-label" for="hojuRate-2">10%（スジ9本 無スジ28）</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="hojuRate" id="hojuRate-3" value="15">
                    <label class="form-check-label" for="hojuRate-3">15%（スジ12本 無スジ28）</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="hojuRate" id="hojuRate-4" value="20">
                    <label class="form-check-label" for="hojuRate-4">20%（スジ14本 無スジ28）</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="hojuRate" id="hojuRate-5" value="25">
                    <label class="form-check-label" for="hojuRate-5">25%（スジ16本 無スジ28）</label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">順目</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="junme" id="junme-1" value="8" checked>
                    <label class="form-check-label" for="junme-1">8順目</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="junme" id="junme-2" value="11">
                    <label class="form-check-label" for="junme-2">11順目</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="junme" id="junme-3" value="14">
                    <label class="form-check-label" for="junme-3">14順目</label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">自分</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="youAreParent" id="youAreParent-1" value="0"
                        checked>
                    <label class="form-check-label" for="youAreParent-1">子</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="youAreParent" id="youAreParent-2" value="1">
                    <label class="form-check-label" for="youAreParent-2">親</label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">相手</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="oponentIsParent" id="oponentIsParent-1" value="0"
                        checked>
                    <label class="form-check-label" for="oponentIsParent-1">子</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="oponentIsParent" id="oponentIsParent-2"
                        value="1">
                    <label class="form-check-label" for="oponentIsParent-2">親</label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">一発 or ドラ</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="isDora" id="isDora-1" value="1">
                    <label class="form-check-label" for="isDora-1">Yes</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="isDora" id="isDora-2" value="0" checked>
                    <label class="form-check-label" for="isDora-2">No</label>
                </div>
            </div>
            <div class="mb-3 text-center">
                <button type="button" class="btn btn-primary w-100" onclick="check()">判定</button>
            </div>
            <div class="mb-3 text-center">
                <div id="result" class="p-3" style="text-align: center;"></div>
            </div>
    </div>
    </div>
</body>

</html>

<script>
    function check() {
        const rule = document.querySelector('input[name="rule"]:checked').value;
        const round = document.querySelector('input[name="round"]:checked').value;
        const score = document.querySelector('input[name="score"]:checked').value;
        const point = document.querySelector('input[name="point"]:checked').value;
        const isRyokei = document.querySelector('input[name="isRyokei"]:checked').value;
        const hojuRate = document.querySelector('input[name="hojuRate"]:checked').value;
        const junme = document.querySelector('input[name="junme"]:checked').value;
        const youAreParent = document.querySelector('input[name="youAreParent"]:checked').value;
        const oponentIsParent = document.querySelector('input[name="oponentIsParent"]:checked').value;
        const isDora = document.querySelector('input[name="isDora"]:checked').value;

        const result = document.querySelector('#result');

        if (rule === "tenhou") {
            result.textContent = "天鳳ルールは未対応です";
            result.style.backgroundColor = "#FFFFFF";
        } else {
            const yourScore = this.getYourScore(score);
            const requiredScore = this.getRequiredScore(hojuRate, junme, oponentIsParent, youAreParent, isRyokei, isDora);

            console.log("Your score is " + yourScore);
            console.log("Required score is " + requiredScore);

            // TODO requiredScoreがundefinedの場合（例えば自分も相手も親を選択された場合）の処理を追加する

            if (yourScore > requiredScore) {
                result.textContent = "押し！";
                result.style.color = "#fff";
                result.style.backgroundColor = "#2cb696";
            } else {
                result.textContent = "降り！";
                result.style.color = "#fff";
                result.style.backgroundColor = "#C94055";
            }
        }
    }

    function getYourScore(score) {
        // TODO 打点を計算するロジックを実装する
        score = parseInt(score);

        return score;
    }

    function getRequiredScore(hojuRate, junme, oponentIsParent, youAreParent, isRyokei, isDora) {
        // 押し引き表を取得
        const oc = this.getOshihikiChart();

        var score;

        // 配列の中から、パラメータが一致するものを検索
        for (var i = 0; i < oc.length; i++) {
            if (hojuRate == oc[i].hojuRate && junme == oc[i].junme && oponentIsParent == oc[i].oponentIsParent && youAreParent == oc[i].youAreParent && isRyokei == oc[i].isRyokei && isDora == oc[i].isDora) {

                // 要求打点を取得
                score = parseInt(oc[i].score);

                break;
            }
        }

        // TODO 和了価値指標の計算

        return score;
    }

    function getOshihikiChart() {
        // 押し引き表をCSVファイルから配列に変換
        var request = new XMLHttpRequest();
        request.open("GET", "oshihiki.csv", false);
        request.send(null);

        var csvData = request.responseText;
        var lines = csvData.split("\n");
        var result = [];
        var headers = lines[0].split(",");
        for (var i = 1; i < lines.length; i++) {
            var obj = {};
            var currentLine = lines[i].split(",");
            for (var j = 0; j < headers.length; j++) {
                obj[headers[j]] = currentLine[j];
            }
            result.push(obj);
        }

        return result;
    }
</script>

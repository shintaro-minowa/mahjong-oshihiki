<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>麻雀 押し引き判定（副露 vs リーチ）</title>
    <!-- Bootstrap CSSを読み込む -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <style>
        .form-check-input:checked {
            background-color: #238F76 !important;
            border-color: #238F76 !important;
        }

        .btn-primary {
            background-color: #238F76 !important;
            border-color: #238F76 !important;
        }

        .form-label {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2 class="text-center mt-5 mb-4" style="font-weight: bold;">麻雀 押し引き判定<br><span style="font-size: 0.6em;">（副露 vs
                リーチ）</span></h2>
        <form id="form" class="bg-light rounded-3 p-4">
            <div class="mb-3">
                <label class="form-label">ルール</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="rule" id="rule-1" value="1" checked>
                    <label class="form-check-label" for="rule-1">Mリーグルール<span style="font-size: small;">（25,000点持ち
                            30,000点返し ウマ1-3）</span></label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="rule" id="rule-2" value="2">
                    <label class="form-check-label" for="rule-2">天鳳ルール<span style="font-size: small;">（段位戦
                            七段）</span></label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">場</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="ba" id="ba-1" value="1" checked>
                    <label class="form-check-label" for="ba-1">東1局</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="ba" id="ba-2" value="2">
                    <label class="form-check-label" for="ba-2">東2局</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="ba" id="ba-3" value="3">
                    <label class="form-check-label" for="ba-3">東3局</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="ba" id="ba-4" value="4">
                    <label class="form-check-label" for="ba-4">東4局</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="ba" id="ba-5" value="5">
                    <label class="form-check-label" for="ba-5">南1局</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="ba" id="ba-6" value="6">
                    <label class="form-check-label" for="ba-6">南2局</label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">供託</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="kyotaku" id="kyotaku-1" value="1000" checked>
                    <label class="form-check-label" for="kyotaku-1">1,000点</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="kyotaku" id="kyotaku-2" value="2000">
                    <label class="class=" form-check-label" for="kyotaku-2">2,000点</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="kyotaku" id="kyotaku-3" value="3000">
                    <label class="form-check-label" for="kyotaku-3">3,000点</label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">自分</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="youAreParent" id="youAreParent-1" value="0"
                        checked>
                    <label class="form-check-label" for="youAreParent-1">子</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="youAreParent" id="youAreParent-2" value="1">
                    <label class="form-check-label" for="youAreParent-2">親</label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">相手</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="oponentIsParent" id="oponentIsParent-1" value="0"
                        checked>
                    <label class="form-check-label" for="oponentIsParent-1">子</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="oponentIsParent" id="oponentIsParent-2"
                        value="1">
                    <label class="form-check-label" for="oponentIsParent-2">親</label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">持ち点</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="yourPoint" id="yourPoint-1" value="15000">
                    <label class="form-check-label" for="yourPoint-1">14,000点 ~ 16,000点</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="yourPoint" id="yourPoint-2" value="25000"
                        checked>
                    <label class="form-check-label" for="yourPoint-2">24,000点 ~ 26,000点</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="yourPoint" id="yourPoint-3" value="35000">
                    <label class="form-check-label" for="yourPoint-3">34,000点 ~ 36,000点</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="yourPoint" id="yourPoint-4" value="45000">
                    <label class="form-check-label" for="yourPoint-4">44,000点 ~ 46,000点</label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">順目</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="junme" id="junme-1" value="8" checked>
                    <label class="form-check-label" for="junme-1">8順目</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="junme" id="junme-2" value="11">
                    <label class="form-check-label" for="junme-2">11順目</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="junme" id="junme-3" value="14">
                    <label class="form-check-label" for="junme-3">14順目</label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">打点</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="han" id="han-1" value="1" checked>
                    <label class="form-check-label" for="han-1">子 1,000点 親 1,500点</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="han" id="han-2" value="2">
                    <label class="form-check-label" for="han-2">子 2,000点 親 2,900点</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="han" id="han-3" value="3">
                    <label class="form-check-label" for="han-3">子 3,900点 親 5,800点</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="han" id="han-4" value="4">
                    <label class="form-check-label" for="han-4">子 7,700点 親 11,600点</label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">待ち</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="isRyokei" id="isRyokei-1" value="1" checked>
                    <label class="form-check-label" for="isRyokei-1">良形</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="isRyokei" id="isRyokei-2" value="0">
                    <label class="form-check-label" for="isRyokei-2">愚形</label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">放銃率</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="hojuRate" id="hojuRate-1" value="5" checked>
                    <label class="form-check-label" for="hojuRate-1">5%<span style="font-size: small;">（スジ9本
                            外側28）</span></label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="hojuRate" id="hojuRate-2" value="10">
                    <label class="form-check-label" for="hojuRate-2">10%<span style="font-size: small;">（スジ9本
                            無スジ28）</span></label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="hojuRate" id="hojuRate-3" value="15">
                    <label class="form-check-label" for="hojuRate-3">15%<span style="font-size: small;">（スジ12本
                            無スジ28）</span></label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="hojuRate" id="hojuRate-4" value="20">
                    <label class="form-check-label" for="hojuRate-4">20%<span style="font-size: small;">（スジ14本
                            無スジ28）</span></label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="hojuRate" id="hojuRate-5" value="25">
                    <label class="form-check-label" for="hojuRate-5">25%<span style="font-size: small;">（スジ16本
                            無スジ28）</span></label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">一発 or ドラ</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="isDora" id="isDora-1" value="1">
                    <label class="form-check-label" for="isDora-1">Yes</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="isDora" id="isDora-2" value="0" checked>
                    <label class="form-check-label" for="isDora-2">No</label>
                </div>
            </div>
            <div class="mb-3 text-center">
                <button type="button" class="btn btn-primary w-100" onclick="judge()">判定</button>
            </div>
            <div class="mb-3 text-center">
                <div id="result" class="p-3" style="text-align: center;"></div>
            </div>
        </form>
    </div>

    <footer class="bg-light py-3 mt-auto">
        <div class="container d-flex justify-content-center">
            <div class="row">
                <div class="col-md-12 text-center">
                    <p>参考文献</p>
                    <ul class="list-unstyled">
                        <li><a href="https://amzn.to/2IYJhtJ"> 「統計学」のマージャン戦術</a></li>
                        <li><a href="https://note.com/unimaru_shikura/n/nf759b8f1a0c7">副露テンパイ vs リーチ 押し引き表</a></li>
                    </ul>
                    <br>
                    <p>作者</p>
                    <ul class="list-unstyled">
                        <li><a href="https://twitter.com/minotchi">みのっち</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

</body>

</html>

<script>
    function judge() {
        // 判定結果を非表示
        const result = document.querySelector('#result');
        result.style.display = "none";

        // 入力された値を取得
        const rule = document.querySelector('input[name="rule"]:checked').value;
        const ba = document.querySelector('input[name="ba"]:checked').value;
        // このアプリでは30符固定
        const fu = 30;
        const han = document.querySelector('input[name="han"]:checked').value;
        const kyotaku = document.querySelector('input[name="kyotaku"]:checked').value;
        const yourPoint = document.querySelector('input[name="yourPoint"]:checked').value;
        const isRyokei = document.querySelector('input[name="isRyokei"]:checked').value;
        const hojuRate = document.querySelector('input[name="hojuRate"]:checked').value;
        const junme = document.querySelector('input[name="junme"]:checked').value;
        const youAreParent = document.querySelector('input[name="youAreParent"]:checked').value;
        const oponentIsParent = document.querySelector('input[name="oponentIsParent"]:checked').value;
        const isDora = document.querySelector('input[name="isDora"]:checked').value;

        // 自分の打点を取得
        const yourScore = this.getYourScore(rule, fu, han, kyotaku, youAreParent);
        // 要求打点を取得
        const requiredScore = this.getRequiredScore(rule, ba, yourPoint, hojuRate, junme, oponentIsParent, youAreParent, isRyokei, isDora);

        // 結果の詳細のテキストを作成
        const details = this.createDetails();

        // 0.5秒待機してから、結果を表示
        setTimeout(function () {

            this.result(yourScore, requiredScore, details);

            result.style.display = "block";
        }, 500);
    }

    function getYourScore(rule, fu, han, kyotaku, youAreParent) {
        console.log("----------- 自分の打点を取得 ----------- ");
        var yourScore;

        console.log("ルール = " + rule);
        console.log("符 = " + fu);
        console.log("翻 = " + han);
        console.log("親であるか = " + youAreParent);

        const ms = this.getArrayFromCsv("mahjong_score.csv");

        // 配列の中から、パラメータが一致するものを検索
        for (var i = 0; i < ms.length; i++) {
            if (rule == ms[i].rule && fu == ms[i].fu && han == ms[i].han && youAreParent == ms[i].youAreParent) {

                // 打点を取得
                yourScore = parseInt(ms[i].score);

                break;
            }
        }

        if (yourScore === undefined) {
            return undefined;
        }

        console.log("自分の打点 = " + yourScore);
        console.log("供託 = " + kyotaku);

        yourScore += parseInt(kyotaku);

        console.log("供託追加後の自分の打点 = " + yourScore);

        return yourScore;
    }

    function getRequiredScore(rule, ba, yourPoint, hojuRate, junme, oponentIsParent, youAreParent, isRyokei, isDora) {
        console.log("----------- 要求打点を取得 ----------- ");
        var requiredScore;

        // 押し引き表を取得
        const oc = this.getArrayFromCsv("oshihiki.csv");

        // 配列の中から、パラメータが一致するものを検索
        for (var i = 0; i < oc.length; i++) {
            if (hojuRate == oc[i].hojuRate && junme == oc[i].junme && oponentIsParent == oc[i].oponentIsParent && youAreParent == oc[i].youAreParent && isRyokei == oc[i].isRyokei && isDora == oc[i].isDora) {

                // 要求打点を取得
                requiredScore = parseInt(oc[i].score);

                break;
            }
        }

        if (requiredScore === undefined) {
            return undefined;
        }

        // 和了価値を取得
        horaValue = this.getHoraValue(rule, ba, yourPoint);
        console.log("和了価値による調整前の要求打点 = " + requiredScore);

        // 要求打点を和了価値で調整
        //   例えば、天鳳ルール、南2局、持ち点が15000点だと、和了の価値は通常の1.57倍になる。
        //   和了の価値が高くなるとき、要求打点は下がるので、要求打点を和了価値で割って調整する。
        requiredScore /= horaValue;
        console.log("和了価値による調整後の要求打点 = " + requiredScore);

        // 100の位で切り捨て
        //   例）16340.129 -> 16300
        requiredScore = Math.floor(requiredScore / 100) * 100;
        console.log("100の位で切り捨てた後の要求打点 = " + requiredScore);

        return requiredScore;
    }

    function getHoraValue(rule, ba, yourPoint) {
        var horaValue;

        // 和了価値指標を取得
        const hvi = this.getArrayFromCsv("hora_value_index.csv");

        // 配列の中から、パラメータが一致するものを検索
        for (var i = 0; i < hvi.length; i++) {
            if (rule == hvi[i].rule && ba == hvi[i].ba && yourPoint == hvi[i].yourPoint) {

                // 和了価値を取得
                horaValue = parseFloat(hvi[i].value);

                break;
            }
        }
        console.log("和了価値 = " + horaValue);

        return horaValue;
    }

    function getArrayFromCsv(csvFileName) {
        // CSVファイルを配列に変換
        var request = new XMLHttpRequest();
        request.open("GET", csvFileName, false);
        request.send(null);

        var csvData = request.responseText;
        var lines = csvData.split("\n");
        var result = [];
        var headers = lines[0].split(",");
        for (var i = 1; i < lines.length; i++) {
            var obj = {};
            var currentLine = lines[i].split(",");
            for (var j = 0; j < headers.length; j++) {
                obj[headers[j]] = currentLine[j];
            }
            result.push(obj);
        }

        return result;
    }

    function result(yourScore, requiredScore, details) {
        console.log("----------- 判定 ----------- ");
        console.log("自分の打点 = " + yourScore);
        console.log("要求打点 = " + requiredScore);

        const result = document.querySelector('#result');

        result.style.color = "#fff";
        result.style.fontSize = "1.5rem";

        if (yourScore === undefined || requiredScore === undefined) {
            result.textContent = "判定できません";
            result.style.backgroundColor = "#880000";
            console.log("判定できません");

            return;
        }

        // 判定結果の詳細を追加
        let note = document.createElement("p");
        note.style.fontSize = "0.8rem";
        note.style.marginTop = "10px";
        note.style.textAlign = "center";

        if (yourScore >= requiredScore) {
            console.log("押し！");
            result.textContent = "押し！";
            result.style.backgroundColor = "#2cb696";

            note.textContent = "自分の打点(" + yourScore + "点) ≧ 要求打点(" + requiredScore + "点)";
            // note.textContent = details;
            result.appendChild(note);

        } else {
            console.log("降り！");
            result.textContent = "降り！";
            result.style.backgroundColor = "#C94055";

            note.textContent = "自分の打点(" + yourScore + "点) < 要求打点(" + requiredScore + "点)";
            result.appendChild(note);
        }
    }

    function createDetails() {
        details = "";

        // ダミーデータ
        details = "自分の打点(9999点) ≧ 要求打点(8888点)\\ntest";

        return details;
    }
</script>
